<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rotcod Admin Dashboard</title>
<style>
  body { font-family: Arial,sans-serif; background:#f3f4f6; margin:0; color:#111; transition:0.3s; }
  body.dark-mode { background:#121212; color:#eee; }
  header { background:#1e40af; color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; }
  header h1 { margin:0; font-size:24px; }
  header button { padding:8px 12px; border:none; border-radius:5px; cursor:pointer; background:#2563eb; color:white; }
  main { padding:20px; }
  .metrics { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:20px; margin-bottom:30px; }
  .metric-box { background:white; border-radius:10px; padding:20px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
  body.dark-mode .metric-box { background:#1f2937; }
  table { width:100%; border-collapse:collapse; margin-top:20px; }
  th,td { border:1px solid #ccc; padding:8px; text-align:center; }
  body.dark-mode th, body.dark-mode td { border-color:#555; }
  input[type="text"] { padding:8px; width:200px; margin-right:10px; }
  button.export-btn { background:#16a34a; }
  body.dark-mode button.export-btn { background:#22c55e; }
</style>
</head>
<body>

<header>
  <h1>ðŸ“Š Rotcod Admin Dashboard</h1>
  <div>
    <button onclick="toggleDarkMode()">ðŸŒ™ Dark Mode</button>
    <button onclick="logout()">Logout</button>
  </div>
</header>

<main>
  <div class="metrics">
    <div class="metric-box">
      <h3>Total Sales</h3>
      <p id="totalSales">$0</p>
    </div>
    <div class="metric-box">
      <h3>Total Profit</h3>
      <p id="totalProfit">$0</p>
    </div>
    <div class="metric-box">
      <h3>Bundles Sold</h3>
      <p id="bundlesSold">0</p>
    </div>
    <div class="metric-box">
      <h3>Total Transactions</h3>
      <p id="totalTx">0</p>
    </div>
  </div>

  <div>
    <input type="text" id="searchInput" placeholder="Search by Customer or Phone" oninput="filterTable()">
    <button class="export-btn" onclick="exportExcel()">Export Excel</button>
  </div>

  <canvas id="bundleChart" style="max-width:600px; margin-top:20px;"></canvas>

  <table id="txTable">
    <thead>
      <tr>
        <th>ID</th><th>Customer</th><th>Phone</th><th>Bundle</th><th>Price</th><th>Fee</th><th>Profit</th><th>Time</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
const BACKEND = "https://rotcod-backend.onrender.com";

// Dark Mode
function toggleDarkMode() {
  document.body.classList.toggle("dark-mode");
}

// Logout
function logout() {
  localStorage.removeItem("rotcod_admin");
  window.location.href="login.html";
}

// Load Dashboard Data
async function loadDashboard() {
  const res = await fetch(BACKEND + "/api/transactions");
  const tx = await res.json();

  // Update metrics
  let totalSales=0,totalProfit=0,bundlesSold=0;
  const bundleCount={};
  tx.forEach(t=>{
    totalSales+=t.price;
    totalProfit+=t.profit;
    bundlesSold++;
    bundleCount[t.bundle]=(bundleCount[t.bundle]||0)+1;
  });
  document.getElementById("totalSales").innerText="$"+totalSales;
  document.getElementById("totalProfit").innerText="$"+totalProfit;
  document.getElementById("bundlesSold").innerText=bundlesSold;
  document.getElementById("totalTx").innerText=tx.length;

  // Fill table
  const tbody=document.querySelector("#txTable tbody");
  tbody.innerHTML="";
  tx.forEach(t=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${t.id}</td><td>${t.customer}</td><td>${t.phone}</td><td>${t.bundle}</td><td>${t.price}</td><td>${t.fee}</td><td>${t.profit}</td><td>${t.time}</td>`;
    tbody.appendChild(tr);
  });

  // Bundle Chart
  const ctx=document.getElementById("bundleChart").getContext("2d");
  if(window.bundleChart) window.bundleChart.destroy();
  window.bundleChart = new Chart(ctx,{
    type:'bar',
    data:{
      labels:Object.keys(bundleCount),
      datasets:[{label:'Bundles Sold',data:Object.values(bundleCount),backgroundColor:'#2563eb'}]
    },
    options:{responsive:true,plugins:{legend:{display:false}}}
  });
}

// Filter Table
function filterTable() {
  const input = document.getElementById("searchInput").value.toLowerCase();
  document.querySelectorAll("#txTable tbody tr").forEach(tr=>{
    const text = tr.innerText.toLowerCase();
    tr.style.display=text.includes(input)?"":"none";
  });
}

// Export Excel
function exportExcel() {
  const table = document.getElementById("txTable");
  const wb = XLSX.utils.table_to_book(table,{sheet:"Transactions"});
  XLSX.writeFile(wb,"Rotcod_Transactions.xlsx");
}

// Auto-refresh every 20s
setInterval(loadDashboard,20000);

// Check login
if(localStorage.getItem("rotcod_admin")!=="true"){ window.location.href="login.html"; }

// Initial load
loadDashboard();
</script>
</body>
</html>

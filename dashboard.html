<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ“Š Rotcod Admin Dashboard</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin:0; background:#f3f4f6; transition: background 0.3s, color 0.3s; }
  header { display:flex; justify-content:space-between; align-items:center; background:#1e40af; color:white; padding:15px 20px; }
  header h1 { margin:0; font-size:24px; display:flex; align-items:center; gap:10px; }
  header button { background:#2563eb; color:white; border:none; padding:8px 12px; border-radius:5px; cursor:pointer; margin-left:10px; }
  header button:hover { background:#1e40af; }
  .metrics { display:flex; gap:20px; margin:20px; flex-wrap:wrap; }
  .card { background:white; padding:15px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); flex:1 1 150px; text-align:center; }
  .card h2 { margin:0; font-size:20px; color:#1e40af; }
  .card p { margin:5px 0 0; font-size:18px; font-weight:bold; }
  #transactions-container { margin:20px; }
  table { width:100%; border-collapse: collapse; }
  th, td { padding:10px; border:1px solid #ddd; text-align:center; }
  th { background:#1e40af; color:white; }
  #chartContainer { width:100%; max-width:800px; margin:20px auto; }
  .dark-mode { background:#111827; color:white; }
  .dark-mode table th { background:#2563eb; color:white; }
  .dark-mode .card { background:#1f2937; color:white; }
</style>
</head>
<body>

<header>
  <h1>ðŸ“Š Rotcod Admin Dashboard</h1>
  <div>
    <button onclick="toggleDarkMode()">ðŸŒ™ Dark Mode</button>
    <button onclick="logout()">Logout</button>
  </div>
</header>

<div class="metrics">
  <div class="card">
    <h2>Float Balance</h2>
    <p id="floatBalance">$0.00</p>
  </div>
  <div class="card">
    <h2>Total Sales</h2>
    <p id="totalSales">$0</p>
  </div>
  <div class="card">
    <h2>Total Profit</h2>
    <p id="totalProfit">$0</p>
  </div>
  <div class="card">
    <h2>Bundles Sold</h2>
    <p id="bundlesSold">0</p>
  </div>
  <div class="card">
    <h2>Total Transactions</h2>
    <p id="totalTransactions">0</p>
  </div>
</div>

<div style="margin:20px;">
  <input type="text" id="searchInput" placeholder="Search by Customer or Phone" oninput="filterTable()" style="padding:8px;width:300px;margin-bottom:10px;">
  <button onclick="exportTableToExcel('transactions', 'transactions')">Export Excel</button>
</div>

<div id="transactions-container">
  <table id="transactions">
    <thead>
      <tr>
        <th>ID</th>
        <th>Customer</th>
        <th>Phone</th>
        <th>Bundle</th>
        <th>Price</th>
        <th>Fee</th>
        <th>Profit</th>
        <th>Time</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="chartContainer">
  <canvas id="salesChart"></canvas>
</div>

<script>
const BACKEND_URL = "https://rotcod-backend.onrender.com";

// Dark mode toggle
function toggleDarkMode() {
  document.body.classList.toggle("dark-mode");
}

// Logout
function logout() {
  localStorage.removeItem("rotcod_admin");
  window.location.href = "login.html";
}

// Check login
if (!localStorage.getItem("rotcod_admin")) {
  window.location.href = "login.html";
}

// Fetch transactions and update dashboard
async function loadDashboard() {
  const res = await fetch(BACKEND_URL + "/api/transactions");
  const transactions = await res.json();

  // Update metrics
  const totalSales = transactions.reduce((a,t) => a + t.price,0);
  const totalProfit = transactions.reduce((a,t) => a + t.profit,0);
  const bundlesSold = transactions.length;
  const totalTransactions = transactions.length;
  const floatBalance = totalProfit * 2; // Example: set float balance logic

  document.getElementById("totalSales").innerText = "$" + totalSales;
  document.getElementById("totalProfit").innerText = "$" + totalProfit;
  document.getElementById("bundlesSold").innerText = bundlesSold;
  document.getElementById("totalTransactions").innerText = totalTransactions;
  document.getElementById("floatBalance").innerText = "$" + floatBalance;

  // Fill table
  const tbody = document.querySelector("#transactions tbody");
  tbody.innerHTML = "";
  transactions.forEach(t => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${t.id}</td>
      <td>${t.customer}</td>
      <td>${t.phone}</td>
      <td>${t.bundle}</td>
      <td>${t.price}</td>
      <td>${t.fee}</td>
      <td>${t.profit}</td>
      <td>${t.time}</td>
    `;
    tbody.appendChild(row);
  });

  // Prepare chart data
  const bundleCounts = {};
  transactions.forEach(t => {
    bundleCounts[t.bundle] = (bundleCounts[t.bundle] || 0) + 1;
  });

  const ctx = document.getElementById('salesChart').getContext('2d');
  if (window.salesChart) window.salesChart.destroy();
  window.salesChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Object.keys(bundleCounts),
      datasets: [{
        label: 'Bundles Sold',
        data: Object.values(bundleCounts),
        backgroundColor: '#2563eb'
      }]
    },
    options: { responsive:true, plugins:{ legend:{ display:false } } }
  });
}

// Search/filter table
function filterTable() {
  const filter = document.getElementById("searchInput").value.toLowerCase();
  const rows = document.querySelectorAll("#transactions tbody tr");
  rows.forEach(row => {
    row.style.display = [...row.cells].some(td => td.innerText.toLowerCase().includes(filter)) ? "" : "none";
  });
}

// Export table to Excel
function exportTableToExcel(tableID, filename = '') {
  const table = document.getElementById(tableID);
  const html = table.outerHTML.replace(/ /g, '%20');
  const a = document.createElement('a');
  a.href = 'data:application/vnd.ms-excel,' + html;
  a.download = filename ? filename + '.xls' : 'excel_data.xls';
  a.click();
}

// Auto refresh every 60 seconds
setInterval(loadDashboard, 60000);

// Initial load
loadDashboard();
</script>

</body>
</html>
